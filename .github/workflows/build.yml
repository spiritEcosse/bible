name: Github CI build

on:
  push:
    branches: [  ]
  pull_request:
    branches: [  ]

env:
  RELEASE: 4.3.0.12
  SAILFISH_IMAGE: coderus/sailfishos-platform-sdk:$RELEASE

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Prepare
      run: mkdir -p ~/3rdparty

    - name: Set up a cache for 3rdparty
      uses: actions/cache@v3
      with: 
        path: /home/runner/3rdparty
        key: sailfish-3rdparty-${{ hashFiles('*') }}
        restore-keys: sailfish-3rdparty-
      
    - name: ls -la /home/runner/3rdparty
      run: ls -la /home/runner/3rdparty
      
    - name: mv 3rdparty 3rdparty_original
      run: mv 3rdparty 3rdparty_original

    - name: cp -fr /home/runner/3rdparty .
      run: cp -fr /home/runner/3rdparty .
      
    - name: cp -fr 3rdparty_original/* 3rdparty
      run: cp -fr 3rdparty_original/* 3rdparty

    - name: Build aarch64
      run: docker run --rm --privileged -v $PWD:/share coderus/sailfishos-platform-sdk:$RELEASE /bin/bash -c "
            cd /share/3rdparty &&
            sudo mkdir -p test &&
            sudo touch test/.test.txt &&
            sudo touch test/test_.txt &&
            sudo touch .new_file &&
            sudo touch new_file_today &&
            sudo touch rrr.txt
            "

    - name: ls -la 3rdparty
      run: ls -la 3rdparty

    - name:  3rdparty /home/runner/3rdparty
      run: rsync -arvP --delete 3rdparty/ /home/runner/3rdparty

    - name: ls -la /home/runner/3rdparty/test
      run: ls -la /home/runner/3rdparty/test
